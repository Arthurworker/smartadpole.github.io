---
layout: article
title:  "「CV」 图像相似度计算概述"
date:   2019-06-25 18:06:40 +0800
key: image-similarities-survey-20190625
aside:
  toc: true
category: [CV, retrival]
---
<span id='head'></span>  

>图像相似度计算是对两幅图像之间内容的相似程度进行打分；   
可用于*模板匹配*，进而应用到**检测**和**跟踪**中（根据已有模板，找到一个与之最接近的区域），比如 BlobTracking，Meanshift，Camshift，粒子滤波等；另一方方面，可用于基于图像内容的**图像检索**，也就是通常说的以图检图，通常的做法是抽取特征，比如 Trace变换，图像哈希或者 Sift 特征向量等，然后计算特征的距离；     

<!--more-->  

# 1 基于图像
## 1.1 峰值信噪比
>PSNR（Peak Signal to Noise Ratio）   
参考全图的图像质量评价指标；        

最常用的图像客观评价指标；    
**原理**：但是它是基于对应像素点间的误差，也就是基于误差敏感的图像质量评价；    
**特点**：并没有考虑人眼的视觉特征：   
  - 对空间频率较低的对比差异敏感度较高，    
  - 对亮度对比差异的敏感度较色度高，    
  - 对区域的感知结果受邻域影响等；   
因此评价结果与人的主观常常不一致；    
**公式**：   
$$
\begin{align}
MSE &= {1 \over {H \times W}} \sum_{i = 1}^{H} \sum_{i = 1}^{W} (X_{i, j} - Y_{i, j})^2 \label{mse} \\   
PSNR &= 10 \log_{10} {(2^n -1)^2 \over {MSE}} \label{PSNR}
\end{align}
$$
注：$MSE$ 表示当前图像 $X$ 和参考图像 $Y$ 的均方误差（Mean Square Error），$H$、$W$ 分别为图像的高度和宽度；$n$ 为每像素的比特数，一般取 8，即像素灰阶数为 256；$PSNR$ 的单位是 dB，数值越大表示失真越小；    
`PSNR 为什么要这么定义啊`{:.warning}   

## 1.2 结构相似性
>SSIM（structural similarity）   
参考全图的图像质量评价指标；分别从亮度、对比度、结构三方面度量图像相似性；    

**公式**：    
$$
\begin{align}
l(X, Y) =& {2 \mu_X \mu_Y + C_1} \over {\mu_X^2 + \mu_Y^2 + C_1} \label{light} \\
c(X, Y) =& {2 \sigma_X \sigma_Y +C_2} \over {\sigma_X^2 + \sigma_Y^2 + C_2} \label{contrast}  \\
s(X, Y) =& {\sigma_{XY} + C_3} \over {\sigma_X \sigma_Y + C3} \label{structure} \\
SSIM(X, Y) &= l(X, Y) \cdot c(X, Y) \cdot s(X, Y) \label{SSIM}
\end{align}
$$
注：其中 $\mu_X, \mu_Y$ 分别表示图像 $X$ 和 $Y$ 的均值，$\sigma_X, \sigma_Y$ 分别表示图像 $X$ 和 $Y$ 的方差，$\sigma_{XY}$ 表示图像 $X$ 和 $Y$ 的协方差；$C_1、C_2、C_3$ 为常数，为了避免分母为 0 的情况，通常取 $C_1=(K_1 \times L)^2$, $C_2=(K_2 \times L)^2$, $C_3=C_2/2$, 一般地 $K_1=0.01, K_2=0.03, L=255$；       

SSIM取值范围[0,1]，值越大，表示图像失真越小；    

实际应用中，可以利用滑窗方式；考虑到窗口形状对分块的影响，采用高斯加权计算每一窗口的均值、方差以及协方差，然后计算对应块的结构相似度 SSIM，最后将平均值作为两图像的结构相似性度量，即平均结构相似性 MSSIM；   

## 1.3 直方图
**步骤**：计算图像的直方图——>取两个直方图的归一化相关系数（巴氏距离，直方图相交距离）；     
**缺点**：   
- 直方图反映的是像素灰度值的概率分布，而没有考虑位置关系（比如图像的骨架，物体形状）；很明显，一个上黑下白的图像和上白下黑的图像其直方图分布是一模一样的；    
- 距离度量采用的是巴氏距离或者归一化相关系数，这种用分析数学向量的方法去分析图像，本身就是一个很不好的办法；    
- 从信息量角度来看，用一个数值来衡量两幅图像的相似度，是一个信息压缩的过程，那么肯定就会存在不准确性；    
**改进**：   
- FragTrack：滑窗，每个窗口进行直方图匹配；融入了位置信息，但是计算低效；`咋地低效了，不都是遍历了所有像素`{:.warning}    
- 对前景取凸包，再对凸包做 Delauny 三角形分解，最后对每个三角形做直方图匹配；      


# 2 基于特征
## 2.1 感知哈希
>perceptual hash algorithm    
对每张图像生成一个「指纹」(fingerprint)字符串，然后比较不同图像的指纹；结果越接近，就说明图像越相似；    

**步骤**：缩小尺寸——>灰度级简化——>计算均值——>计算哈希——>计算汉明距离；[详细说明](#hash_progress)   
**代码示例**：    

## 2.2 矩阵分解
>矩阵特征值计算方法有SVD、NMF、Trace变换，不变矩等；    

### 2.2.1 SVD
>奇异值分解是基于整体的表示；

不但具有正交变换、旋转、位移、镜像映射等代数和几何上的不变性,而且具有良好的稳定性和抗噪性，广泛应用于模式识别与图像分析中；   
**目的**：得到唯一、稳定的特征描述；降低特征空间的维数；提高抵抗干扰和噪声的能力；    
**缺点**：但是由于奇异值分解得到的奇异矢量中有负数存在所以不能很好的解释其物理意义；    

- 稳定性   
- 比例不变性   
- 旋转不变性   
- 压缩性          

### 2.2.3 NMF
>非负矩阵分解；    

**原理**：将非负矩阵分解为可以体现图像主要信息的基矩阵与系数矩阵，并且可以对基矩阵赋予很好的解释，比如对人脸的分割，得到的基向量正是人的「眼睛」，「鼻子」等主要概念特征，源图像表示为这些特征的加权组合；所以 NMF 算法也在人脸识别等场合中发挥着巨大的作用；

## 2.3 特征点计算
>可以适应多角度的情况；`旋转，还是视角转换`{:.warning}    

### 2.3.1 Harris 角点

### 2.3.2 Sift 特征点
[David G. Lowe](https://www.cs.ubc.ca/~lowe/)    
**优点**：抗旋转和噪声的效果很好；   

# 2 各种方法优劣对比

|  | PSNR | SSIM | 直方图 | 感知哈希 | SVD | NMF | 特征点 | 深度特征提取 |   
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 优势 |  |  |  |  |  |  |  |  |
| 劣势 | 未考虑人眼特性 |  |  |  |  |  |  |  |


-------------------  
[End](#head)
{:.warning}  


# 附录
## A 参考资料
1. wangyaning. OpenCV进行图像相似度对比的几种办法[EB/OL]. <https://www.cnblogs.com/wangyaning/p/7854046.html>. 2017-11-17/2019-06-26.  

## B 基本概念
<span id='hash_progress'>**1. 感知哈希的计算过程**</span>    
**缩小尺寸**：将图像缩小到 8*8 的尺寸；主要是为了去除图像的细节，只保留结构/明暗等基本信息，摒弃不同尺寸/比例带来的图像差异；    
**灰度级简化**：将缩小的图像转换为 64 个灰度级；    
**计算均值**：计算图像的灰度均值；    
**计算哈希值**：64 个像素点大于或等于平均值的记为 1，小于平均值记为 0，结果就是哈希值；    
**比对**：计算两个哈希值的汉明距离，距离不超过5，为相似；大于10，就是两张不同的图像；   

「汉明距离」Hamming distance，在信息论中，两个等长字符串之间的汉明距离是两个字符串对应位置的不同字符的个数；      

## C 英文名称

| 中文 | 英文 | 中文 | 英文 |
| --- | --- | --- | --- |
| 感知哈希 | perceptual hash | 灰度级 |  |
