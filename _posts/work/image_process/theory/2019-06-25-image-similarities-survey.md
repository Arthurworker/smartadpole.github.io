---
layout: article
title:  "「CV」 图像相似度计算概述"
date:   2019-06-25 18:06:40 +0800
key: image-similarities-survey-20190625
aside:
  toc: true
category: [image_process]
---
<span id='head'></span>  

>图像相似度计算是对两幅图像之间内容的相似程度进行打分；其直接关系到图像检索的结果和检索效率；        
可用于*模板匹配*，进而应用到**检测**和**跟踪**中（根据已有模板，找到一个与之最接近的区域），比如 BlobTracking，Meanshift，Camshift，粒子滤波等；另一方方面，可用于基于图像内容的**图像检索**，也就是通常说的以图检图，通常的做法是抽取特征，比如 Trace变换，图像哈希或者 Sift 特征向量等，然后计算特征的距离；     

<!--more-->  

`把距离度量函数单独提取出来，这里只放完整的解决方案`{:.warning}    

# 1 基于灰度特征
>要比较的两幅图像在语义上无包含关系；    

## 1.1 Minkowsky 距离
**公式**：   
$$
\begin{align}
L_p(A, B) &= [\sum_{i=1}^n |a_i - b_i|^p]^{1 \over p} \label{minkowsky} \\   
\end{align}
$$

p = 1 时， 为 L1 距离：   
>绝对值距离，又叫城区距离(city-block)；       

p = 1 时， 为 L2 距离：    
>又叫 Euclideandistance，或均方误差，MSE（Mean Square Error）；         

**公式**：   
$$
\begin{align}
MSE &= {1 \over {H \times W}} \sum_{i = 1}^{H} \sum_{j = 1}^{W} (X_{i, j} - Y_{i, j})^2 \label{mse} \\   
\end{align}
$$
注：$MSE$ 表示当前图像 $X$ 和参考图像 $Y$ 的均方误差（Mean Square Error），$H$、$W$ 分别为图像的高度和宽度；    

p = 1 时， 为切比雪夫距离：   
>Chebyshevdistance；    

**公式**：   
$$
\begin{align}
L_\infty &= \max_{i=1}^n |a_i - b_i| \label{cheby} \\   
\end{align}
$$

## 1.3 $\chi^2$ 距离

## 1.4 查找颜色表

## 1.5 中心矩

## 1.6 直方图
**步骤**：计算图像的直方图——>取两个直方图的归一化相关系数（巴氏距离，直方图相交距离）；     
**优点**：   
- 能够很好地归一化，计算量适中；    
**缺点**：   
- 直方图反映的是像素灰度值的概率分布，而没有考虑位置关系（比如图像的骨架，物体形状）；很明显，一个上黑下白的图像和上白下黑的图像其直方图分布是一模一样的；    
- 距离度量采用的是巴氏距离或者归一化相关系数，这种用分析数学向量的方法去分析图像，本身就是一个很不好的办法；    
- 从信息量角度来看，用一个数值来衡量两幅图像的相似度，是一个信息压缩的过程，那么肯定就会存在不准确性；    
**改进**：   
- FragTrack：滑窗，每个窗口进行直方图匹配；融入了位置信息，但是计算低效；`咋地低效了，不都是遍历了所有像素`{:.warning}    
- 对前景取凸包，再对凸包做 Delauny 三角形分解，最后对每个三角形做直方图匹配；      

## 1.7 峰值信噪比
>PSNR（Peak Signal to Noise Ratio）   
参考全图的图像质量评价指标；        

最常用的图像客观评价指标；    
**原理**：但是它是基于对应像素点间的误差，也就是基于误差敏感的图像质量评价；    
**特点**：并没有考虑人眼的视觉特征：   
  - 对空间频率较低的对比差异敏感度较高，    
  - 对亮度对比差异的敏感度较色度高，    
  - 对区域的感知结果受邻域影响等；   
因此评价结果与人的主观常常不一致；    
**公式**：   
$$
\begin{align}
PSNR &= 10 \log_{10} {(2^n -1)^2 \over {MSE}} \label{PSNR}
\end{align}
$$
注：$MSE$ 见公式 $\eqref{mse}$，$n$ 为每像素的比特数，一般取 8，即像素灰阶数为 256；$PSNR$ 的单位是 dB，数值越大表示失真越小；    
`PSNR 为什么要这么定义啊`{:.warning}   

## 1.8 结构相似性
>SSIM（structural similarity）   
参考全图的图像质量评价指标；分别从亮度、对比度、结构三方面度量图像相似性；    

**公式**：    
$$
\begin{align}
l(X, Y) =& {2 \mu_X \mu_Y + C_1} \over {\mu_X^2 + \mu_Y^2 + C_1} \label{light} \\
c(X, Y) =& {2 \sigma_X \sigma_Y +C_2} \over {\sigma_X^2 + \sigma_Y^2 + C_2} \label{contrast}  \\
s(X, Y) =& {\sigma_{XY} + C_3} \over {\sigma_X \sigma_Y + C3} \label{structure} \\
SSIM(X, Y) &= l(X, Y) \cdot c(X, Y) \cdot s(X, Y) \label{SSIM}
\end{align}
$$
注：其中 $\mu_X, \mu_Y$ 分别表示图像 $X$ 和 $Y$ 的均值，$\sigma_X, \sigma_Y$ 分别表示图像 $X$ 和 $Y$ 的方差，$\sigma_{XY}$ 表示图像 $X$ 和 $Y$ 的协方差；$C_1、C_2、C_3$ 为常数，为了避免分母为 0 的情况，通常取 $C_1=(K_1 \times L)^2$, $C_2=(K_2 \times L)^2$, $C_3=C_2/2$, 一般地 $K_1=0.01, K_2=0.03, L=255$；       

SSIM取值范围[0,1]，值越大，表示图像失真越小；    

实际应用中，可以利用滑窗方式；考虑到窗口形状对分块的影响，采用高斯加权计算每一窗口的均值、方差以及协方差，然后计算对应块的结构相似度 SSIM，最后将平均值作为两图像的结构相似性度量，即平均结构相似性 MSSIM；   

## 1.9 感知哈希
>perceptual hash algorithm    
对每张图像生成一个「指纹」(fingerprint)字符串，然后比较不同图像的指纹；结果越接近，就说明图像越相似；    

**步骤**：缩小尺寸——>灰度级简化——>计算均值——>计算哈希——>计算汉明距离；[详细说明](#hash_progress)   
**代码示例**：    

# 2 基于纹理的
## 2.1 欧氏距离
常用欧氏距离；   

## 2.2 马氏距离
>Mahalanobis distance；   

如果特征向量各分量间具有相关性或具有不同权重，适合用马氏距离；   

**公式**：   
$$
\begin{align}
D_{mahal} &= (A-B)^T C^{-1}(A-B) \label{mahal}
\end{align}
$$

# 3 各种方法优劣对比

|  | PSNR | SSIM | 直方图 | 感知哈希 |
| --- | --- | --- | --- | --- |
| 优势 |  |  |  |  |
| 劣势 | 未考虑人眼特性 |  |  |  |

*若两幅图像是局部物体相似，需忽略背景部分时，就需要用模板匹配找相似区域，或者提取复杂的特征来进行相似度计算——特征点、深度特征等；*    

-------------------  
[End](#head)
{:.warning}  


# 附录
## A 参考资料
1. wangyaning. OpenCV进行图像相似度对比的几种办法[EB/OL]. <https://www.cnblogs.com/wangyaning/p/7854046.html>. 2017-11-17/2019-06-26.  

## B 基本概念
<span id='hash_progress'>**1. 感知哈希的计算过程**</span>    
**缩小尺寸**：将图像缩小到 8*8 的尺寸；主要是为了去除图像的细节，只保留结构/明暗等基本信息，摒弃不同尺寸/比例带来的图像差异；    
**灰度级简化**：将缩小的图像转换为 64 个灰度级；    
**计算均值**：计算图像的灰度均值；    
**计算哈希值**：64 个像素点大于或等于平均值的记为 1，小于平均值记为 0，结果就是哈希值；    
**比对**：计算两个哈希值的汉明距离，距离不超过5，为相似；大于10，就是两张不同的图像；   

「汉明距离」Hamming distance，在信息论中，两个等长字符串之间的汉明距离是两个字符串对应位置的不同字符的个数；      

## C 英文名称

| 中文 | 英文 | 中文 | 英文 |
| --- | --- | --- | --- |
| 感知哈希 | perceptual hash | 灰度级 |  |
